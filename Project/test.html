<html>
<head>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script>
        class Node {
            // Constructor for node class. Take element (shape), type (Walkable Platform, Energy Drink etc..), 
            // xCoord that stays static (used for hitboxes), yCoord that stays static (used for hitboxes), width, height
            constructor(element, type, xCoord, yCoord, Width, Height) {
                this.element = element;
                this.type = type;
                this.xCoord = xCoord;
                this.yCoord = yCoord;
                this.Width = Width;
                this.Height = Height;
                this.next = null
            }
        }

        class LinkedList {

            // Constructor for linkedlist. assigns head and size to defaults
            constructor() {
                this.head = null;
                this.size = 0;
            }

            // This function adds an object to the linkedlist using the node class and reformats the linked list to have
            // an appropriate size, head pointer, and next pointers
            add(element, type, xCoord, yCoord, Width, Height) {
                // creates a new node
                var node = new Node(element, type, xCoord, yCoord, Width, Height);

                // to store current node
                var current;

                // if list is Empty add the
                // element and make it head
                if (this.head == null)
                    this.head = node;
                else {
                    current = this.head;

                    // iterate to the end of the
                    // list
                    while (current.next) {
                        current = current.next;
                    }

                    // add node
                    current.next = node;
                }
                this.size++;
            }

            // This function returns an object at a specified index but does not remove it from the list. Used for hitboxes
            returnFrom(index) {
                var curr, prev, it = 0;
                curr = this.head;
                prev = curr;

                // iterate over the list to the
                // position to removce an element
                while (it < index) {
                    it++;
                    prev = curr;
                    curr = curr.next;
                }
                return curr;
            }

            // This function is like the returnFrom function except it removes the object instead of returning it to be used. Used
            // to improve performance after items have been collected.
            removeFrom(index) {
                if (index > 0 && index > this.size)
                    return -1;
                else {
                    var curr, prev, it = 0;
                    curr = this.head;
                    prev = curr;

                    // deleting first element
                    if (index === 0) {
                        this.head = curr.next;
                    } else {
                        // iterate over the list to the
                        // position to removce an element
                        while (it < index) {
                            it++;
                            prev = curr;
                            curr = curr.next;
                        }

                        // remove the element
                        prev.next = curr.next;
                    }
                    this.size--;

                    // return the remove element
                    return curr;
                }
            }

            // This function returns if the linkedlist is empty
            isEmpty() {
                return this.size == 0;
            }

            // finds the index of element
            indexOf(element) {
                var count = 0;
                var current = this.head;

                // iterate over the list
                while (current != null) {
                    // compare each element of the list
                    // with given element
                    if (current.element === element)
                        return count;
                    count++;
                    current = current.next;
                }

                // not found
                return -1;
            }
        }

        var gameInfo = {
            framerate: 60
        };

        var input = {
            spacebar: false,
            pause: false,
            shift: false,
            'resetInput': function () {
                this.spacebar = false;
            }
        };

        var player = {
            x: 50, y: 50,
            movex: 0, movey: 0,
            grounded: false,
            jumpForce: 25,
            maxGravity: 10,
            moveSpeed: 5,
            character : new createjs.Sprite(new createjs.SpriteSheet({
                // declare where to find spritesheet
                "images": ["Character Images/Spritesheet.png"],
                // assign 4 frames from spritesheet
                "frames": [
                    [1, 1, 21, 31, 0, -5, -1],
                    [24, 1, 21, 31, 0, -5, -1],
                    [47, 1, 17, 31, 0, -6, -1],
                    [66, 1, 17, 31, 0, -6, -1]
                ],
                // assign animation "run" from frame indeces 0, 2, 1, 3
                "animations": {
                    "run": {
                        frames: [0, 2, 1, 3],
                        next: "run",
                        speed: 0.07
                    }
                }
            }), "run"),
            'resetMove': function () {
                this.movex = 0;

            },
            'update': function () {
                this.resetMove();
                //gravity

                this.movey += 2;
                if (this.movey > this.maxGravity) this.movey = this.maxGravity;

                //detect collisions
                //if ground is detected, stop movey=0;
                //example

                if (this.grounded) {
                    this.movey = 0;
                }

                if (input.spacebar == true && this.grounded == true) {
                    this.movey -= 20;
                    this.grounded = false;
                }
                this.x += this.movex;
                this.y += this.movey;

                //Update everything
                this.character.x = this.x;
                this.character.y = this.y;
            }
        };

        // Change levelNo based on which level needs loading. Change objectSpeed and destination off screen to your liking.
        // Change animSpeed to increase or decrease how fast the animation runs. NOTE: this will not speed up the character, just the animation
        var levelNo = 1;
        //var objectSpeed = 25000, objectDestinationX = -6000;
        //var animSpeed = 0.07;

        // Don't touch these variables, they are very sensitive and will lash back at you :P
        var platforms = new LinkedList(), obtainables = new LinkedList();
        //var character, noOfJumps = 2;
        var onPlatform = false, jumping = false, switchedGravity = false;
        var backgroundBitmap;
        var playerAnimInterval, gravityInterval, checkPlatformIntersectionInterval, checkObtainableIntersectionInterval, backgroundInterval, checkDeathInterval, staminaInterval, capacitorInterval;
        var staminaText = new createjs.Text(), healthText = new createjs.Text(), capacitorText = new createjs.Text();
        var stamina = 0, health = 100, capacitor = 0;
        var stats = new createjs.Container();
        stats.x = 0;
        var platform;
        var stage;

        var text = new createjs.Text();
        text.font = "20px Arial";
        text.x = 800;
        text.y = 10;
        text.color = "Green";

        function init() {
            stage = new createjs.Stage("demoCanvas");
            window.addEventListener("keydown", keyDown, false);
            window.addEventListener("keyup", keyUp, false);
            //test player
            stage.addChild(player.character);

            //test platform 1
            /*platform = new createjs.Shape();
            platform.graphics.beginFill("Black").drawRect(20, 400, 200, 20)
            stage.addChild(platform);

            //test platform 1
            platform2 = new createjs.Shape();
            platform2.graphics.beginFill("Black").drawRect(300, 400, 200, 200)
            stage.addChild(platform2);
            stage.update();*/
            loadLevel();

            createjs.Ticker.on("tick", update);
            createjs.Ticker.framerate = gameInfo.framerate;
        }

        function update() {
            player.update();
            checkPlatformIntersection();
            moveObjects();
            stage.update();
        }

        function moveObjects() {
            for (x = 0; x < platforms.size; x++) {
                var currentObject = platforms.returnFrom(x);
                stage.removeChild(currentObject.element);
                currentObject.element.x -= 4;
                stage.addChild(currentObject.element);
            }
        }

        function loadLevel() {
            // remove all shapes and obtainables currently in level linked list
            while (platforms.isEmpty() == false)
                platforms.removeFrom(0);
            /*while (obtainables.isEmpty() == false)
                obtainables.removeFrom(0);*/

            // reset variables
            /*stage.removeChild(stats);
            health = 100;
            capacitor = 0;
            onPlatform = false;
            switchedGravity = false;
            character.rotation = 0;*/

            // reload background
            //loadBackgroundImages();

            // Set all intervals required for level to run
            /*clearInterval(capacitorInterval);
            clearInterval(backgroundInterval);
            backgroundInterval = setInterval(backgroundAnimation, 1);
            clearInterval(checkPlatformIntersectionInterval);
            checkPlatformIntersectionInterval = setInterval(checkPlatformIntersection, 1);
            clearInterval(gravityInterval);
            gravityInterval = setInterval(gravity, 1);
            clearInterval(checkDeathInterval);
            checkDeathInterval = setInterval(checkDeath, 1);
            clearInterval(staminaInterval);
            staminaInterval = setInterval(modifyStamina, 200, -1);
            clearInterval(checkObtainableIntersectionInterval);
            checkObtainableIntersectionInterval = setInterval(checkObtainableIntersection, 1);*/

            // set text of health and capacitor appropriately
            /*healthText.text = "Health: " + health;
            capacitorText.text = "Capacitor Charge: " + capacitor;*/

            // create level one shapes
            if (levelNo == 1) {
                createWalkablePlatform(50, 300, 900, 30);
                createWalkablePlatform(1050, 400, 250, 60);
                createWalkablePlatform(1400, 300, 250, 30);
                createChocoBar(1200, 161);
                createEnergyDrink(2000, 170);
                createWalkablePlatform(1800, 200, 350, 30);
                createWalkablePlatform(2300, 400, 250, 30);
                createWalkablePlatform(2800, 400, 250, 30);
                createCapacitor(2950, 381);
                createWalkablePlatform(3300, 400, 250, 30);
                createWalkablePlatform(3700, 300, 250, 30);
                createWalkablePlatform(4100, 200, 100, 30);
                createWalkablePlatform(4300, 300, 100, 30);
                createWalkablePlatform(4500, 400, 250, 30);
                createWalkablePlatform(5000, 400, 250, 30);
                createWalkablePlatform(5400, 300, 250, 30);
                createWalkablePlatform(5800, 200, 100, 30);
                createEndingPlatform(6000, 300, 250, 30);
                //stamina = 350;
            }
            // create level two shapes
            else if (levelNo == 2) {
                createWalkablePlatform(50, 400, 900, 30);
                createWalkablePlatform(750, 100, 600, 30);
                createChocoBar(1050, 131);
                createEndingPlatform(1200, 200, 400, 30);
                //stamina = 350;
            }
            // create level three shapes
            else if (levelNo == 3) {
                createWalkablePlatform(50, 500, 900, 100);
                createWalkablePlatform(750, 200, 600, 30);
                createChocoBar(1050, 181);
                createWalkablePlatform(1500, 0, 400, 200);
                createWalkablePlatform(1150, 500, 400, 300);
                //stamina = 350;
            }

            // set stamina text from variable defined in if statement block above
            //staminaText.text = "Stamina: " + stamina;

            // add shapes to stage
            for (x = 0; x < platforms.size; x++)
                stage.addChild(platforms.returnFrom(x).element);
            // add obtainables to stage
            for (x = 0; x < obtainables.size; x++)
                stage.addChild(obtainables.returnFrom(x).element);

            // add stats container that holds the health, stamina, and capacitor charge to stage
            //stage.addChild(stats);

            // reset character
            /*stage.removeChild(character);
            character.y = 0;
            stage.addChild(character);*/
        }

        // This function creates a walkable platform
        function createWalkablePlatform(xCoord, yCoord, Width, Height) {
            createPlatform(xCoord, yCoord, Width, Height, "Black");
        }

        // This function creates a death platform
        function createDeathPlatform(xCoord, yCoord, Width, Height) {
            createPlatform(xCoord, yCoord, Width, Height, "Red");
        }

        // This function creates an ending platform
        function createEndingPlatform(xCoord, yCoord, Width, Height) {
            createPlatform(xCoord, yCoord, Width, Height, "Green");
        }

        // This function creates a chocolate bar
        function createChocoBar(xCoord, yCoord) {
            createObtainable(xCoord, yCoord, "Brown", "Chocolate Bar");
        }

        // This function creates an energy drink
        function createEnergyDrink(xCoord, yCoord) {
            createObtainable(xCoord, yCoord, "Green", "Energy Drink");
        }

        // This function creates a capacitor
        function createCapacitor(xCoord, yCoord) {
            createObtainable(xCoord, yCoord, "Yellow", "Capacitor");
        }

        // This function creates a platform either walkable, death, or ending and adds it to the platforms list
        function createPlatform(xCoord, yCoord, Width, Height, color) {
            // create shape with graphics, add to platforms list
            var shape = new createjs.Shape();
            shape.graphics.beginFill(color).drawRect(xCoord, yCoord, Width, Height);

            // Depending on color, add to platforms list accordingly with the type specified
            if (color == "Green")
                platforms.add(shape, "Ending Platform", xCoord, yCoord, Width, Height);
            else if (color == "Red")
                platforms.add(shape, "Death Platform", xCoord, yCoord, Width, Height);
            else if (color == "Black")
                platforms.add(shape, "Walkable Platform", xCoord, yCoord, Width, Height);
        }

        // This function creates an obtainable object either a chocolate bar, energy drink, or capacitor and adds it to the obtainables list
        function createObtainable(xCoord, yCoord, color, type) {
            // create shape with graphics, add to obtainables list
            var shape = new createjs.Shape();
            shape.graphics.beginFill(color).drawRect(xCoord, yCoord, 25, 25);

            // Depending on color, add to obtainables list accordingly with the type specified
            if (type == "Chocolate Bar")
                obtainables.add(shape, "Chocolate Bar", xCoord, yCoord);
            else if (type == "Energy Drink")
                obtainables.add(shape, "Energy Drink", xCoord, yCoord);
            else if (type == "Capacitor")
                obtainables.add(shape, "Capacitor", xCoord, yCoord);
        }

        // This function checks for collisions between the player and the platforms on the level
        function checkPlatformIntersection() {
            for (var x = 0; x < platforms.size; x++) {
                var currentObject = platforms.returnFrom(0);
                var pt1 = player.character.localToLocal(0, 30, currentObject.element);
                if (currentObject.element.hitTest(player.x, player.y + 30)) {
                    player.grounded = true;
                }
                else if (pt1.x >= (currentObject.xCoord + currentObject.Width)) {
                    player.grounded = false;
                    platforms.removeFrom(0);
                }
            }

        }

        function keyDown(e) {
            //spacebar
            if (e.keyCode == "32") input.spacebar = true;
        }

        function keyUp(e) {
            //spacebar
            if (e.keyCode == "32") input.spacebar = false;
        }

    </script>
</head>
<body onload="init();">
    <canvas id="demoCanvas" width="1520" height="735"></canvas>
</body>
</html>