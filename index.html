<html>
<head>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
    <script src="https://code.createjs.com/soundjs-0.6.2.min.js"></script>
    <script>
        class Node {
            // Constructor for node class. Take element (shape), type (Walkable Platform, Energy Drink etc..),
            // xCoord that stays static (used for hitboxes), yCoord that stays static (used for hitboxes), width, height
            constructor(element, type, xCoord, yCoord, Width, Height) {
                this.element = element;
                this.type = type;
                this.xCoord = xCoord;
                this.yCoord = yCoord;
                this.Width = Width;
                this.Height = Height;
                this.next = null
            }
        }

        class LinkedList {
            // Constructor for linkedlist. assigns head and size to defaults
            constructor() {
                this.head = null;
                this.size = 0;
            }

            // This function adds an object to the linkedlist using the node class and reformats the linked list to have
            // an appropriate size, head pointer, and next pointers
            add(element, type, xCoord, yCoord, Width, Height) {
                // creates a new node
                var node = new Node(element, type, xCoord, yCoord, Width, Height);

                // to store current node
                var current;

                // if list is Empty add the
                // element and make it head
                if (this.head == null) this.head = node;
                else {
                    current = this.head;

                    // iterate to the end of the
                    // list
                    while (current.next) current = current.next;
                    // add node
                    current.next = node;
                }
                this.size++;
            }

            // This function returns an object at a specified index but does not remove it from the list. Used for hitboxes
            returnFrom(index) {
                var curr, prev, it = 0;
                curr = this.head;
                prev = curr;

                // iterate over the list to the
                // position to removce an element
                while (it < index) {
                    it++;
                    prev = curr;
                    curr = curr.next;
                }
                return curr;
            }

            // This function is like the returnFrom function except it removes the object instead of returning it to be used. Used
            // to improve performance after items have been collected or platforms have moved offscreen.
            removeFrom(index) {
                if (index > 0 && index > this.size) return -1;
                else {
                    var curr, prev, it = 0;
                    curr = this.head;
                    prev = curr;

                    // deleting first element
                    if (index === 0) {
                        this.head = curr.next;
                    } else {
                        // iterate over the list to the
                        // position to removce an element
                        while (it < index) {
                            it++;
                            prev = curr;
                            curr = curr.next;
                        }

                        // remove the element
                        prev.next = curr.next;
                    }
                    this.size--;

                    // return the remove element
                    return curr;
                }
            }

            // This function returns 0 if the linkedlist is empty
            isEmpty() {
                return this.size == 0;
            }

            // finds the index of element
            indexOf(element) {
                var count = 0;
                var current = this.head;

                // iterate over the list
                while (current != null) {
                    // compare each element of the list
                    // with given element
                    if (current.element === element) return count;
                    count++;
                    current = current.next;
                }

                // not found
                return -1;
            }
        }

        var stage;
        var levelNo = 1;
        var platforms = new LinkedList(), obtainables = new LinkedList(), objectSpeed = 1;
        var character, noOfJumps = 2, animSpeed = 0.07;
        var onPlatform = false, jumping = false, switchedGravity = false;
        var backgroundBitmap;
        var gravityInterval, staminaInterval, capacitorInterval, gameInterval;
        var staminaText = new createjs.Text(), healthText = new createjs.Text(), capacitorText = new createjs.Text();
        var stamina = 0, health = 100, capacitor = 0;
        var stats = new createjs.Container();
        const platformType = {
            REGULAR: 'regular',
            DEATH: 'death',
            END: 'end',
        }
        const obtainableType = {
            CHOCOBAR: 'chocobar',
            ENERGYDRINK: 'energydrink',
            CAPACITOR: 'capacitor',
        }

        // Initializes the game on first launch
        function init() {
            // set canvas width and height based on users screen
            var height = window.innerHeight - 20;
            var width = window.innerWidth - 20;
            var canvas = document.getElementById("demoCanvas");
            canvas.setAttribute("width", width);
            canvas.setAttribute("height", height);
            // even listener for keyboard input
            window.addEventListener("keydown", keyboardInput, false);
            // create stage
            stage = new createjs.Stage("demoCanvas");
            // loads character, then stats, and then the level
            loadCharacter();
            initializeText();
            loadLevel();
            // set ticker
            createjs.Ticker.setFPS(60);
            createjs.Ticker.addEventListener("tick", stage);
        }

        // This function initializes the text (health, stamina, and capacitor charge) and adds it to a container
        function initializeText() {
            // Init stamina
            staminaText.font = "20px Arial";
            staminaText.color = "Green";
            staminaText.x = 200;
            staminaText.y = 10;

            // Init health
            healthText.font = "20px Arial";
            healthText.color = "Red";
            healthText.x = 10;
            healthText.y = 10;

            // Init capacitor charge
            capacitorText.font = "20px Arial";
            capacitorText.color = "Yellow";
            capacitorText.x = 410;
            capacitorText.y = 10;

            // add to stats container
            stats.addChild(healthText, staminaText, capacitorText);
        }

        // This function loads the character from a spritesheet then assigns, and executes a run animation
        function loadCharacter() {
            character = new createjs.Sprite(new createjs.SpriteSheet({
                // declare where to find spritesheet
                "images": ["Character Images/Spritesheet.png"],
                // assign 4 frames from spritesheet
                "frames": [
                    [1, 1, 21, 31, 0, -5, -1],
                    [24, 1, 21, 31, 0, -5, -1],
                    [47, 1, 17, 31, 0, -6, -1],
                    [66, 1, 17, 31, 0, -6, -1]
                ],
                // assign animation "run" from frame indeces 0, 2, 1, 3
                "animations": {
                    "run": {
                        frames: [0, 2, 1, 3],
                        next: "run",
                        speed: animSpeed
                    }
                }
            }), "run");
        }

        // This function loads the level eiter from initialization or when killed and respawned
        function loadLevel() {
            // remove all shapes and obtainables currently in level linked list
            while (platforms.isEmpty() == false) platforms.removeFrom(0);
            while (obtainables.isEmpty() == false) obtainables.removeFrom(0);

            // reset stat variables
            stage.removeChild(stats);
            health = 100;
            capacitor = 0;

            // reset player variables
            onPlatform = false;
            switchedGravity = false;
            character.rotation = 0;

            // reset all intervals required for level to run
            clearInterval(capacitorInterval);
            clearInterval(gravityInterval);
            gravityInterval = setInterval(gravity, 1);
            clearInterval(staminaInterval);
            staminaInterval = setInterval(modifyStamina, 200, -1);

            // create bg bitmap. add to stage
            backgroundBitmap = new createjs.Bitmap("Background Images/Bk1-1.png");
            stage.addChild(backgroundBitmap);

            // chain for creating levels. Assign objects, and stamina amount
            if (levelNo == 1) {
                createPlatform(50, 300, 900, 200, platformType.REGULAR)
                createPlatform(1050, 400, 250, 60, platformType.REGULAR)
                createPlatform(1400, 300, 250, 30, platformType.REGULAR);
                createObtainable(1200, 161, obtainableType.CHOCOBAR);
                createObtainable(2000, 170, obtainableType.ENERGYDRINK);
                createPlatform(1800, 200, 350, 30, platformType.REGULAR);
                createPlatform(2300, 400, 250, 30, platformType.REGULAR);
                createPlatform(2800, 400, 250, 30, platformType.REGULAR);
                createObtainable(2950, 381, obtainableType.CAPACITOR);
                createPlatform(3300, 400, 250, 30, platformType.REGULAR);
                createPlatform(3700, 300, 250, 30, platformType.REGULAR);
                createPlatform(4100, 200, 100, 30, platformType.REGULAR);
                createPlatform(4300, 300, 100, 30, platformType.REGULAR);
                createPlatform(4500, 400, 250, 30, platformType.REGULAR);
                createPlatform(5000, 400, 250, 30, platformType.REGULAR);
                createPlatform(5400, 300, 250, 30, platformType.REGULAR);
                createPlatform(5800, 200, 100, 30, platformType.REGULAR);
                createPlatform(6000, 300, 250, 30, platformType.END);
                stamina = 350;
            }
            else if (levelNo == 2) {
                createPlatform(50, 400, 900, 30, platformType.REGULAR);
                createPlatform(750, 100, 600, 30, platformType.REGULAR);
                createObtainable(1050, 131, obtainableType.CHOCOBAR);
                createPlatform(1200, 200, 400, 30, platformType.END);
                stamina = 350;
            }
            // create level three shapes
            else if (levelNo == 3) {
                createPlatform(50, 500, 900, 100, platformType.REGULAR);
                createPlatform(750, 200, 600, 30, platformType.REGULAR);
                createObtainable(1050, 181, obtainableType.CHOCOBAR);
                createPlatform(1500, 0, 400, 200, platformType.REGULAR);
                createPlatform(1150, 500, 400, 300, platformType.REGULAR);
                stamina = 350;
            }

            // add shapes and obtainables to stage
            for (x = 0; x < platforms.size; x++) stage.addChild(platforms.returnFrom(x).element);
            for (x = 0; x < obtainables.size; x++) stage.addChild(obtainables.returnFrom(x).element);

            // set UI stats, add to stage
            healthText.text = "Health: " + health;
            capacitorText.text = "Capacitor Charge: " + capacitor;
            staminaText.text = "Stamina: " + stamina;
            stage.addChild(stats);

            // reset character
            character.y = 0;
            stage.addChild(character);

            // reset main game interval
            clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 1);
        }

        // This function creates a platform either walkable, death, or ending and adds it to the platforms list
        function createPlatform(xCoord, yCoord, Width, Height, type) {
            // create shape
            var shape = new createjs.Shape();
            
            // Depending on type, change graphics, add to platforms list accordingly with the type specified
            if (type == "end") {
                shape.graphics.beginFill("Green").drawRect(xCoord, yCoord, Width, Height);
                platforms.add(shape, "Ending Platform", xCoord, yCoord, Width, Height);
            }
            else if (type == "death") {
                shape.graphics.beginFill("Red").drawRect(xCoord, yCoord, Width, Height);
                platforms.add(shape, "Death Platform", xCoord, yCoord, Width, Height);
            }
            else if (type == "regular") {
                shape.graphics.beginFill("Black").drawRect(xCoord, yCoord, Width, Height);
                platforms.add(shape, "Walkable Platform", xCoord, yCoord, Width, Height);
            }
        }

        // This function creates an obtainable object either a chocolate bar, energy drink, or capacitor and adds it to the obtainables list
        function createObtainable(xCoord, yCoord, type) {
            // create image and bitmap, assign image to bitmap
            var image = new Image();
            var bitmap = new createjs.Bitmap(image);
            bitmap.x = xCoord;
            bitmap.y = yCoord;

            // Depending on type, add to obtainables list accordingly with the type specified and src image
            if (type == "chocobar") {
                image.src = "Obtainable Objects/Choco Bar-1.png";
                obtainables.add(bitmap, "Chocolate Bar", xCoord, yCoord);
            }
            else if (type == "energydrink") {
                image.src = "Obtainable Objects/Energy Drink-1.png";
                obtainables.add(bitmap, "Energy Drink", xCoord, yCoord);
            }
            else if (type == "capacitor") {
                image.src = "Obtainable Objects/Charged Capacitor-1.png";
                obtainables.add(bitmap, "Capacitor", xCoord, yCoord);
            }
        }

        // This function controls the modification of the stamina variable based on an amount sent either + or -
        function modifyStamina(amount) {
            // change stamina
            stamina += amount
            // set text
            staminaText.text = "Stamina: " + stamina;
        }

        // This function controls the modification of the health variable, always removes from health, never adds
        function drainHealth(amount) {
            // change health
            health -= amount;
            // set text
            healthText.text = "Health: " + health;
        }

        // This function controls the modification of the capacitor charge variable, always removes from capacitor charge, never adds
        function drainCapacitor(amount) {
            // change capacitor charge
            capacitor -= amount;
            // set text
            capacitorText.text = "Capacitor Charge: " + capacitor;

            // once capacitor charge reaches 0, reactivate stamina, and stop the capacitor charge from draining
            if (capacitor <= 0) {
                staminaInterval = setInterval(modifyStamina, 200, -1);
                clearInterval(capacitorInterval);
                capacitor = 0;
            }
        }

        // This function controls the gravity for the player
        function gravity() {
            // default gravity direction (Down). Change to your liking but be sure to change the one in the if statement below as well
            var gravityYDirection = 1;

            // when switched gravity is activated, swap the direction of gravity (Up)
            if (switchedGravity == true) gravityYDirection = -1;

            // Move player towards whichever direction is chosen above and set the player's
            // jumping boolean to true to indicate that they are in the air and cannot jump
            character.y += gravityYDirection;

            if (levelNo == 1 || levelNo == 2) jumping = true;
        }

        // This function controls the hitboxes around each obtainable items in the level and performs operations if a collision occurs
        function checkObtainableIntersection() {
            // track the head object in the obtainables list
            for (var x = 0; x < obtainables.size; x++) {
                var currentObject = obtainables.returnFrom(x);

                // create local coordinate to be used for collisions between
                // character and the obtainable item
                var pt1;

                // depending on what gravity is (swapped or not), make a correction to the variables used for hitboxes
                if (switchedGravity == true) {
                    pt1 = character.localToLocal(-1 * currentObject.xCoord, -1 * currentObject.yCoord, currentObject.element);
                    pt1.x -= 15;
                    pt1.y -= 20;
                }
                else pt1 = character.localToLocal(currentObject.xCoord, currentObject.yCoord, currentObject.element);

                // if the player has moved past the current object without picking it up, remove it
                if (currentObject.xCoord < pt1.x - 100) {
                    stage.removeChild(currentObject.element);
                    obtainables.removeFrom(x);
                }

                // This if statement is the false block. It uses constants of 25, 30, 25, and 40 corresponding to object width, player width, object height, and player height respectively
                // If the player is outside of these widths, do not do anything
                else if (pt1.x >= currentObject.xCoord + 25 || pt1.x + 30 <= currentObject.xCoord || pt1.y >= currentObject.yCoord + 25 || pt1.y + 40 <= currentObject.yCoord) { }
                // otherwise, they must be inside the object, so perform one of the operations
                else {
                    // if what they collided with was a chocolate bar then reduce their health by 25 (change to your liking) and remove the object from the stage and the linked list
                    if (currentObject.type == "Chocolate Bar") {
                        document.getElementById("chocolate").play();
                        drainHealth(25);
                        stage.removeChild(currentObject.element);
                        obtainables.removeFrom(x);
                    }
                    // if what they collided with was an energy drink then add 50 to their stamina (change that to your liking) and remove the object from the stage and the linked list
                    else if (currentObject.type == "Energy Drink") {
                        modifyStamina(50);
                        stage.removeChild(currentObject.element);
                        obtainables.removeFrom(x);
                    }
                    // if what they collided with was a capacitor then stop stamina from draining, and start to drain the capacitor charge from 100 to 0 (change capacitor to your liking)
                    // then remove it from the stage and the linked list
                    else if (currentObject.type == "Capacitor") {
                        document.getElementById("powerup").play();
                        clearInterval(staminaInterval);
                        capacitor = 100;
                        capacitorInterval = setInterval(drainCapacitor, 100, 1);
                        stage.removeChild(currentObject.element);
                        obtainables.removeFrom(x);
                    }
                }
            }
        }

        // This function checks for collisions between the player and the platforms on the level
        function checkPlatformIntersection() {
            // for each level object....
            for (var x = 0; x < platforms.size; x++) {
                // track the platform that the loop is on currently
                var currentObject = platforms.returnFrom(x);

                // create local coordinate to be used for collisions between
                // character and current level object
                var pt1 = character.localToLocal(0, 30, currentObject.element);

                // this variable is for if switchedGravity is true. It determines the y value at which the platform is
                var platformY;
                if (switchedGravity == true) platformY = currentObject.Height + currentObject.yCoord;

                if ((currentObject.xCoord + currentObject.Width) < pt1.x - 100) {
                    stage.removeChild(currentObject.element)
                    platforms.removeFrom(x);
                }
                // test for a collision between the character and the current platform
                // if a collision occurs, onPlatform becomes true indicating the player is on the platform
                // and gravity stops pulling the player down (or up depending on gravity) making it seem like they are walking on the platform
                else if ((currentObject.element).hitTest(pt1.x, pt1.y) && ((pt1.y <= platformY && pt1.y >= platformY - 15 && switchedGravity == true) || (pt1.y >= currentObject.yCoord && pt1.y <= currentObject.yCoord + 15 && switchedGravity == false))) {
                    clearInterval(gravityInterval);
                    onPlatform = true;
                    jumping = false;
                    noOfJumps = 2;

                    // if the current object that the player has collided with is a death platform, reset the level
                    if (currentObject.type == "Death Platform") loadLevel();
                    // if the current object that the player has collided with is an ending platform, move to the next level
                    else if (currentObject.type == "Ending Platform") {
                        levelNo++;
                        loadLevel();
                    }
                }
                // when the current platform moves off the screen meaning that the player is past the platform
                // add gravity back to the player so they fall off the platform
                else if (onPlatform == true) {
                    onPlatform = false;
                    gravityInterval = setInterval(gravity, 1);
                }
            }
        }

        function gameLoop() {
            backgroundBitmap.x -= 0.1;
            if (character.y >= 1000 || character.y <= -200 || stamina <= 0 || health <= 0) loadLevel();
            for (var x = 0; x < platforms.size; x++) platforms.returnFrom(x).element.x -= objectSpeed;
            for (var x = 0; x < obtainables.size; x++) obtainables.returnFrom(x).element.x -= objectSpeed;
            checkObtainableIntersection();
            checkPlatformIntersection();
        }

        function keyboardInput(e) {
            // default values for where the player is going to jump to, the rotation of the player
            // and the correction x and y factor for the player.
            // correctionXYFactor is the amount that the player must move on the x and y axis
            // so they dont look like they teleported
            // change jumpHeight to your liking but be sure to change the one in the if statement below
            var jumpHeight = -200, rotation = 180, correctionXYFactor = 30;

            // Swap the values if swapped gravity is true
            if (switchedGravity == true) jumpHeight = 200, rotation = -180, correctionXYFactor = -30;

            // When keycode 32 (Space) is pressed and the player is not already jumping, make the player jump.
            // change the value inside modifyStamina after the negative sign to subtract more stamina per jump.
            // change the 800 and 3 in the tween below to modify how jumping works
            if (e.keyCode == "32" && jumping == false) {
                document.getElementById("jump").play();
                if (capacitor <= 0) modifyStamina(-20);
                if (noOfJumps >= 0) {
                    jumping = true;
                    createjs.Tween.get(character, { loop: false }).to({ y: character.y + jumpHeight }, 800, createjs.Ease.getPowInOut(3));
                }
                else noOfJumps--;
            }
            else if (e.keyCode == "80") {
                var paused = !createjs.Ticker.getPaused();
                createjs.Ticker.setPaused(paused);
            }
            else if (e.keyCode == "17") {
                if (objectSpeed >= 2.5) objectSpeed = 1;
                else objectSpeed += 0.5;
            }
            // When keycode 16 (Shift) is pressed and levelNo is 2 or 3 (swap gravity mechanic enabled)
            // rotate the player based on rotation defined above and correct the players position
            else if (e.keyCode == "16" && (levelNo == 2 || levelNo == 3) && jumping == false) {
                document.getElementById("antigravity").play();
                if (capacitor <= 0) modifyStamina(-20);

                jumping = true;
                character.rotation += rotation;
                character.x += correctionXYFactor;
                character.y += correctionXYFactor;

                // Swap the gravity to its opposite
                switchedGravity = !switchedGravity;
            }
        }
    </script>
</head>
<body onload="init();">
    <audio id="jump" preload="auto" type="audio/wav" src="Sounds/Jump_01.wav"></audio>
    <audio id="chocolate" preload="auto" type="audio/wav" src="Sounds/Error.wav"></audio>
    <audio id="powerup" preload="auto" type="audio/wav" src="Sounds/Powerup.wav"></audio>
    <audio id="antigravity" preload="auto" type="audio/wav" src="Sounds/Swoosh.wav"></audio>
    <audio id="bgmusic" preload="auto" type="audio/mpeg" src="Sounds/Crimson_Fly.mp3"></audio>
    <canvas id="demoCanvas"></canvas>
</body>
</html>